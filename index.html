<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scottsdale Athan — Salat Times</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{max-width:820px;margin:24px auto;padding:18px;background:#f7fafc;border-radius:12px;box-shadow:0 6px 24px rgba(16,24,40,.06)}
    h1{font-size:1.6rem;margin:0 0 8px}
    .card{background:white;padding:16px;border-radius:10px;box-shadow:0 2px 6px rgba(2,6,23,.04);}
    .times{display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:center;margin-top:12px}
    .time-row{padding:8px 12px;border-radius:8px;border:1px solid #eee;display:flex;justify-content:space-between}
    .controls{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    button{padding:10px 12px;border-radius:8px;border:none;background:#0ea5a4;color:white;font-weight:600;flex:1}
    button.secondary{background:#64748b}
    .next{margin-top:12px;font-weight:600}
    small{color:#475569}
  </style>
</head>
<body>
  <div class="card">
    <h1>Scottsdale Athan — Salat Times</h1>
    <div><small>Location: Scottsdale, AZ</small></div>

    <div id="status" class="next">Loading prayer times...</div>

    <div id="list" class="times" aria-live="polite"></div>

    <div class="controls">
      <button id="enable">Enable Athan</button>
      <button id="refresh" class="secondary">Refresh Times</button>
    </div>
  </div>

  <audio id="athanAudio" preload="auto" src="https://archive.org/download/AdhanMisharyRashid/AdhanMisharyRashid.mp3"></audio>

  <script>
    const LAT = 33.49417;
    const LON = -111.92605;
    const TIMINGS_API = `https://api.aladhan.com/v1/timings`;
    const audio = document.getElementById('athanAudio');
    let enabled = false;
    let scheduled = [];

    document.getElementById('enable').addEventListener('click', async ()=>{
      try {
        await audio.play();
        audio.pause();
      } catch(e){}
      enabled = true;
      document.getElementById('status').textContent = 'Athan enabled — audio will play at prayer times.';
      document.getElementById('enable').textContent = 'Athan Enabled';
      document.getElementById('enable').disabled = true;
    });

    document.getElementById('refresh').addEventListener('click', ()=> fetchAndSchedule());

    async function fetchAndSchedule(){
      scheduled.forEach(t => clearTimeout(t));
      scheduled = [];

      document.getElementById('status').textContent = 'Fetching times...';

      const params = new URLSearchParams({latitude:LAT, longitude:LON, method:2});
      const url = TIMINGS_API + '?' + params.toString();

      try{
        const res = await fetch(url);
        const data = await res.json();
        if(data.code !== 200){ throw new Error('API error'); }
        const timings = data.data.timings;

        renderTimings(timings);
        scheduleToday(timings);

      }catch(err){
        console.error(err);
        document.getElementById('status').textContent = 'Failed to fetch prayer times — check console.';
      }
    }

    function renderTimings(t){
      const list = document.getElementById('list');
      list.innerHTML = '';
      const order = ['Fajr','Sunrise','Dhuhr','Asr','Maghrib','Isha'];
      order.forEach(name=>{
        const row = document.createElement('div'); row.className='time-row';
        const left = document.createElement('div'); left.textContent = name;
        const right = document.createElement('div'); right.textContent = t[name] || '-';
        row.appendChild(left); row.appendChild(right);
        list.appendChild(row);
      });
    }

    function toLocalDateTime(timeStr){
      const today = new Date();
      const Y = today.getFullYear();
      const M = String(today.getMonth()+1).padStart(2,'0');
      const D = String(today.getDate()).padStart(2,'0');
      const iso = `${Y}-${M}-${D}T${timeStr}:00`;
      return new Date(iso);
    }

    function scheduleToday(timings){
      const prayerNames = ['Fajr','Dhuhr','Asr','Maghrib','Isha'];
      const now = new Date();
      let nextFound=false;
      prayerNames.forEach(name=>{
        const timeStr = timings[name];
        const dt = toLocalDateTime(timeStr);
        if(dt.getTime() <= now.getTime()) return;
        const ms = dt.getTime() - now.getTime();
        const tId = setTimeout(()=>triggerAthan(name), ms);
        scheduled.push(tId);
        if(!nextFound){
          nextFound = true;
          showNext(name, dt);
        }
      });

      if(!nextFound){
        document.getElementById('status').textContent = 'All prayer times for today have passed.';
      }
    }

    function showNext(name, dt){
      const s = document.getElementById('status');
      s.textContent = `Next: ${name} at ${dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`;
      clearInterval(window._countdownInterval);
      window._countdownInterval = setInterval(()=>{
        const now = new Date();
        const diff = Math.max(0, dt.getTime() - now.getTime());
        const hh = Math.floor(diff/3600000); const mm = Math.floor((diff%3600000)/60000); const ss = Math.floor((diff%60000)/1000);
        s.textContent = `Next: ${name} at ${dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} — in ${hh}h ${mm}m ${ss}s`;
        if(diff<=0) clearInterval(window._countdownInterval);
      }, 1000);
    }

    async function triggerAthan(prayerName){
      document.getElementById('status').textContent = `${prayerName} time — playing athan.`;
      if(enabled){
        try{
          audio.currentTime = 0;
          await audio.play();
        }catch(e){
          console.warn('Audio play blocked or failed', e);
          document.getElementById('status').textContent += ' (play blocked by browser)';
        }
      } else {
        document.getElementById('status').textContent += ' (Enable Athan for audio)';
      }
    }

    fetchAndSchedule();

    function msUntilMidnight(){
      const now = new Date();
      const tm = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 0,0,5);
      return tm.getTime() - now.getTime();
    }
    setTimeout(()=>{ fetchAndSchedule(); setInterval(fetchAndSchedule, 24*3600*1000); }, msUntilMidnight());
  </script>
</body>
</html>
